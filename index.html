<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸è‰¯ç‡åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
      background: #f0f4f8;
      color: #1a202c;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #1e4e8c 0%, #2b6cb0 60%, #3182ce 100%);
      color: white;
      padding: 1.1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 3px 12px rgba(0,0,0,0.25);
    }
    header .icon { font-size: 1.8rem; line-height: 1; }
    header h1 { font-size: 1.4rem; font-weight: 800; letter-spacing: 0.02em; }
    header .subtitle { font-size: 0.78rem; opacity: 0.75; margin-top: 0.15rem; letter-spacing: 0.06em; }

    .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1.5rem 3rem; }

    /* ===== Stats ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .stat-card {
      background: white; border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      border-top: 4px solid; text-align: center;
    }
    .stat-card.blue   { border-top-color: #3182ce; }
    .stat-card.green  { border-top-color: #38a169; }
    .stat-card.purple { border-top-color: #805ad5; }
    .stat-card.red    { border-top-color: #e53e3e; }
    .stat-value { font-size: 1.75rem; font-weight: 800; line-height: 1.1; margin-bottom: 0.2rem; }
    .stat-card.blue   .stat-value { color: #2b6cb0; }
    .stat-card.green  .stat-value { color: #276749; }
    .stat-card.purple .stat-value { color: #553c9a; }
    .stat-card.red    .stat-value { color: #c53030; }
    .stat-label { font-size: 0.72rem; color: #718096; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

    /* ===== Tabs ===== */
    .tabs {
      display: flex; background: white; border-radius: 12px;
      padding: 0.4rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 1.25rem; gap: 0.4rem;
    }
    .tab-btn {
      flex: 1; padding: 0.65rem; border: none; background: transparent;
      border-radius: 8px; cursor: pointer; font-size: 0.82rem;
      font-weight: 600; color: #718096; transition: all 0.18s;
    }
    .tab-btn.active { background: #2b6cb0; color: white; box-shadow: 0 2px 8px rgba(43,108,176,0.35); }
    .tab-btn:hover:not(.active) { background: #edf2f7; color: #2d3748; }

    .panel { display: none; }
    .panel.active { display: block; }

    /* ===== Card ===== */
    .card {
      background: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 1.5rem; margin-bottom: 1.25rem;
    }
    .card-title {
      font-size: 0.95rem; font-weight: 700; color: #2d3748;
      margin-bottom: 1.1rem; padding-bottom: 0.7rem;
      border-bottom: 2px solid #e2e8f0;
      display: flex; align-items: center; gap: 0.5rem;
    }

    /* ===== Form ===== */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
    .form-group label { font-size: 0.75rem; font-weight: 700; color: #4a5568; text-transform: uppercase; letter-spacing: 0.06em; }
    .form-group input, .form-group select {
      padding: 0.6rem 0.8rem; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 0.9rem; color: #1a202c; outline: none; background: white;
      transition: border-color 0.18s, box-shadow 0.18s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.15);
    }

    /* ===== Defect rows ===== */
    .defect-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.65rem; }
    .defect-header-label { font-size: 0.75rem; font-weight: 700; color: #4a5568; text-transform: uppercase; letter-spacing: 0.06em; }
    #defect-rows { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem; }
    .defect-row { display: grid; grid-template-columns: 1fr 110px auto; gap: 0.5rem; align-items: center; }
    .defect-row input {
      padding: 0.5rem 0.7rem; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 0.875rem; color: #1a202c; outline: none;
      transition: border-color 0.18s, box-shadow 0.18s;
    }
    .defect-row input:focus { border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.15); }

    /* ===== Buttons ===== */
    .btn {
      padding: 0.55rem 1.1rem; border: none; border-radius: 8px;
      cursor: pointer; font-size: 0.85rem; font-weight: 700;
      transition: all 0.18s; white-space: nowrap;
    }
    .btn-sm { padding: 0.35rem 0.7rem; font-size: 0.78rem; }
    .btn-primary   { background: #2b6cb0; color: white; }
    .btn-primary:hover   { background: #2c5282; box-shadow: 0 2px 8px rgba(43,108,176,0.35); }
    .btn-secondary { background: #edf2f7; color: #4a5568; }
    .btn-secondary:hover { background: #e2e8f0; }
    .btn-danger    { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }
    .btn-danger:hover    { background: #fed7d7; }
    .btn-excel     { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; font-weight: 700; }
    .btn-excel:hover     { background: #fef3c7; }
    .btn-add       { background: #ebf8ff; color: #2a4365; border: 1px solid #bee3f8; }
    .btn-add:hover       { background: #bee3f8; }

    .form-actions {
      display: flex; justify-content: flex-end; gap: 0.75rem;
      margin-top: 1.1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;
    }

    /* ===== Alert ===== */
    .alert {
      padding: 0.7rem 1rem; border-radius: 8px; margin-bottom: 1rem;
      font-size: 0.875rem; font-weight: 600; display: none;
      animation: slideDown 0.2s ease;
    }
    .alert-success { background: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }
    .alert-error   { background: #fff5f5; color: #c53030; border: 1px solid #fc8181; }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ===== Table ===== */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.855rem; }
    th {
      background: #f7fafc; padding: 0.65rem 0.85rem; text-align: left;
      font-size: 0.72rem; font-weight: 700; color: #4a5568;
      text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 2px solid #e2e8f0; white-space: nowrap;
    }
    td { padding: 0.65rem 0.85rem; border-bottom: 1px solid #f0f4f8; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f7fafc; }

    /* ===== Badges ===== */
    .badge {
      display: inline-block; padding: 0.18rem 0.6rem;
      border-radius: 999px; font-size: 0.76rem; font-weight: 700;
    }
    .badge-ok     { background: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }
    .badge-warn   { background: #fffff0; color: #744210; border: 1px solid #f6e05e; }
    .badge-ng     { background: #fff5f5; color: #c53030; border: 1px solid #fc8181; }
    .badge-day    { background: #fefcbf; color: #744210; }
    .badge-night  { background: #ebf4ff; color: #2a4365; }
    .badge-csv    { background: #e9d8fd; color: #553c9a; font-size: 0.7rem; padding: 0.12rem 0.45rem; }
    .badge-manual { background: #e6fffa; color: #234e52; font-size: 0.7rem; padding: 0.12rem 0.45rem; }
    .badge-excel  { background: #fffbeb; color: #92400e; font-size: 0.7rem; padding: 0.12rem 0.45rem; }

    /* ===== CSV Drop area ===== */
    .drop-area {
      border: 2px dashed #cbd5e0; border-radius: 12px; padding: 2.5rem;
      text-align: center; cursor: pointer; transition: all 0.2s; background: #f7fafc;
    }
    .drop-area:hover, .drop-area.drag-over { border-color: #3182ce; background: #ebf8ff; }
    .drop-area .drop-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .drop-area p { color: #718096; font-size: 0.875rem; margin-bottom: 0.4rem; }
    .drop-area .hint { font-size: 0.78rem; color: #a0aec0; }

    /* ===== CSV info / filter rows ===== */
    .info-box {
      background: #f0f9ff; border: 1px solid #bee3f8; border-radius: 8px;
      padding: 0.85rem 1rem; margin-bottom: 1.1rem;
      font-size: 0.84rem; color: #2a4365; line-height: 1.7;
    }
    .ctrl-row {
      display: flex; align-items: center; gap: 0.75rem;
      margin-bottom: 1rem; font-size: 0.85rem; color: #4a5568; flex-wrap: wrap;
    }
    .ctrl-row select {
      padding: 0.4rem 0.7rem; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 0.85rem; outline: none; background: white; cursor: pointer;
    }
    .ctrl-row select:focus { border-color: #3182ce; }

    /* ===== Chart ===== */
    .chart-wrap { position: relative; height: 360px; }

    /* ===== Empty state ===== */
    .empty-state { text-align: center; padding: 3rem 1rem; color: #a0aec0; }
    .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .empty-state p { font-size: 0.875rem; }

    /* ===== Responsive ===== */
    @media (max-width: 700px) {
      .form-grid  { grid-template-columns: 1fr 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .defect-row { grid-template-columns: 1fr 90px auto; }
      .tab-btn    { font-size: 0.75rem; padding: 0.55rem 0.3rem; }
    }
    @media (max-width: 480px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    /* ===== KPI Dashboard ===== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .kpi-card {
      background: white; border-radius: 12px;
      padding: 1.1rem 1.25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      text-align: center;
    }
    .kpi-title {
      font-size: 0.72rem; color: #718096; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem;
    }
    .kpi-value { font-size: 1.55rem; font-weight: 800; line-height: 1.1; }

    /* ===== Print ===== */
    @media print {
      body { background: white !important; }
      header, .stats-grid, .tabs, .alert, .no-print { display: none !important; }
      .panel { display: none !important; }
      #panel-report { display: block !important; }
      .container { max-width: 100% !important; padding: 0.5rem !important; }
      .print-hide { display: none !important; }
      .kpi-grid { display: none !important; }
      .card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; }
    }
    @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }

    /* ===== Path Import ===== */
    .path-import-box {
      background: #f0f9ff; border: 1px solid #bee3f8; border-radius: 10px;
      padding: 0.9rem 1.1rem; margin-top: 1rem;
    }
    .path-import-label {
      font-size: 0.78rem; font-weight: 700; color: #2a4365;
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.65rem;
    }
    .path-import-row {
      display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;
    }
    .path-import-row + .path-import-row { margin-top: 0.5rem; }
    .path-folder-display {
      flex: 2; min-width: 200px; padding: 0.48rem 0.75rem;
      border: 2px solid #bee3f8; border-radius: 8px; font-size: 0.8rem;
      color: #2a4365; background: #ebf8ff; font-style: italic;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .path-import-row input[type="text"] {
      flex: 1; min-width: 160px; padding: 0.48rem 0.75rem;
      border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem;
      color: #1a202c; outline: none; background: white;
      transition: border-color 0.18s, box-shadow 0.18s;
    }
    .path-import-row input[type="text"]:focus {
      border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.15);
    }
    .path-import-row select {
      padding: 0.48rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 0.875rem; outline: none; background: white; cursor: pointer;
    }
    .path-import-row select:focus { border-color: #3182ce; }
    .btn-folder { background: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }
    .btn-folder:hover { background: #c6f6d5; }
    .btn-load { background: #2b6cb0; color: white; border: none; }
    .btn-load:hover { background: #2c5282; box-shadow: 0 2px 8px rgba(43,108,176,0.35); }

    /* ===== Date Range Filter ===== */
    .date-range-row {
      display: flex; align-items: center; gap: 0.5rem;
      flex-wrap: wrap; margin-bottom: 0.85rem;
      padding: 0.55rem 0.9rem; background: #f0f4f8;
      border-radius: 8px; border: 1px solid #e2e8f0;
      font-size: 0.85rem; color: #4a5568;
    }
    .date-range-row label { font-weight: 700; font-size: 0.78rem; color: #4a5568; white-space: nowrap; }
    .date-range-row input[type="date"] {
      padding: 0.35rem 0.6rem; border: 2px solid #e2e8f0;
      border-radius: 8px; font-size: 0.85rem; outline: none; background: white;
      transition: border-color 0.18s;
    }
    .date-range-row input[type="date"]:focus { border-color: #3182ce; }
    .date-range-row .tilde { color: #a0aec0; font-size: 0.95rem; font-weight: 600; }
  </style>
</head>
<body>

<header>
  <div class="icon">ğŸ“Š</div>
  <div>
    <h1>ä¸è‰¯ç‡åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="subtitle">DEFECT RATE ANALYSIS</div>
  </div>
</header>

<div class="container">

  <div class="alert" id="alert"></div>

  <!-- Stats (4 cards) -->
  <div class="stats-grid">
    <div class="stat-card blue">
      <div class="stat-value" id="stat-records">0</div>
      <div class="stat-label">è¨˜éŒ²æ•°</div>
    </div>
    <div class="stat-card green">
      <div class="stat-value" id="stat-defects">0</div>
      <div class="stat-label">ç·ä¸è‰¯æ•°</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-value" id="stat-types">0</div>
      <div class="stat-label">ä¸è‰¯ç¨®åˆ¥æ•°</div>
    </div>
    <div class="stat-card red">
      <div class="stat-value" id="stat-defect-rate">--</div>
      <div class="stat-label">å¹³å‡ä¸è‰¯ç‡</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('input')">âœï¸ æ‰‹å‹•å…¥åŠ›</button>
    <button class="tab-btn" onclick="switchTab('csv')">ğŸ“‚ CSVå–è¾¼</button>
    <button class="tab-btn" onclick="switchTab('trend')">ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰</button>
    <button class="tab-btn" onclick="switchTab('pareto')">ğŸ“Š ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³</button>
    <button class="tab-btn" onclick="switchTab('analysis')">ğŸ“‹ åˆ†æ</button>
    <button class="tab-btn" onclick="switchTab('report')">ğŸ“„ æ—¥å ±ãƒ»æ¯”è¼ƒ</button>
  </div>

  <!-- ===== Panel: Manual Input ===== -->
  <div class="panel active" id="panel-input">
    <div class="card">
      <div class="card-title">âœï¸ æ–°è¦ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</div>
      <div class="form-grid">
        <div class="form-group">
          <label>æ—¥ä»˜</label>
          <input type="date" id="inp-date">
        </div>
        <div class="form-group">
          <label>ã‚·ãƒ•ãƒˆ</label>
          <select id="inp-shift">
            <option value="">-- é¸æŠ --</option>
            <option value="æ˜¼">æ˜¼</option>
            <option value="å¤œ">å¤œ</option>
          </select>
        </div>
        <div class="form-group">
          <label>ç”Ÿç”£æ•°ï¼ˆä»»æ„ï¼‰</label>
          <input type="number" id="inp-production" min="1" placeholder="ä¾‹: 1000">
        </div>
      </div>
      <div class="defect-header">
        <span class="defect-header-label">ä¸è‰¯ç¨®åˆ¥</span>
        <button class="btn btn-add btn-sm" onclick="addDefectRow()">+ è¡Œã‚’è¿½åŠ </button>
      </div>
      <div id="defect-rows"></div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="resetForm()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“„ ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</div>
      <div id="table-manual"></div>
    </div>
  </div>

  <!-- ===== Panel: CSV Import ===== -->
  <div class="panel" id="panel-csv">
    <div class="card">
      <div class="card-title">ğŸ“‚ CSVãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼</div>

      <div class="info-box">
        <strong>CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ1è¡Œ1ä¸è‰¯ï¼‰</strong><br>
        Aåˆ—ï¼æ—¥ä»˜ &nbsp;ï¼&nbsp; Båˆ—ï¼ã‚·ãƒ•ãƒˆï¼ˆæ˜¼ or å¤œï¼‰ &nbsp;ï¼&nbsp; Cåˆ—ï¼ä¸è‰¯å†…å®¹ &nbsp;ï¼&nbsp; Dåˆ—ï¼ç™ºç”Ÿå€‹æ•° &nbsp;ï¼&nbsp; <strong>Fåˆ—ï¼ç·ç”Ÿç”£æ•°</strong><br>
        ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã€‚åŒã˜æ—¥ä»˜ï¼‹ã‚·ãƒ•ãƒˆã®è¡Œã‚’é›†è¨ˆã—ã¦1ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã—ã¾ã™ã€‚Fåˆ—ã®ç”Ÿç”£æ•°ã¯å„ç›´ã§åŒã˜å€¤ãŒå…¥ã£ã¦ã„ã‚‹å‰æã§å…ˆé ­è¡Œã®å€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
      </div>

      <div class="ctrl-row">
        <label for="csv-encoding">æ–‡å­—ã‚³ãƒ¼ãƒ‰ï¼š</label>
        <select id="csv-encoding">
          <option value="utf-8">UTF-8</option>
          <option value="shift-jis">Shift-JISï¼ˆExcelä¿å­˜ï¼‰</option>
        </select>
      </div>

      <div class="drop-area" id="drop-area"
           onclick="document.getElementById('csv-file-input').click()">
        <div class="drop-icon">ğŸ“‚</div>
        <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦CSVã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <div class="hint">.csv ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ</div>
      </div>
      <input type="file" id="csv-file-input" accept=".csv" style="display:none">

      <div id="csv-preview-area" style="margin-top:1.25rem"></div>

      <!-- å“ç•ªåˆ¥ Excel ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå–è¾¼ -->
      <hr style="border:none;border-top:1px solid #e2e8f0;margin:1.5rem 0">
      <div class="card-title" style="font-size:0.95rem;margin-bottom:0.5rem">ğŸ“Š å“ç•ªåˆ¥Excelãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå–è¾¼</div>
      <div class="info-box" style="background:#fffff0;border-color:#d69e2e">
        <strong>å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š</strong>å„å“ç•ªã®é›†è¨ˆã‚·ãƒ¼ãƒˆã‚’Excelã‹ã‚‰ç›´æ¥å–è¾¼ã¿ã¾ã™ã€‚<br>
        6è¡Œç›®ï¼é‡‘å‹ç•ªå· ï¼ 7è¡Œç›®ï¼é‹³é€ ãƒ­ãƒƒãƒˆï¼ˆæœ«å°¾D=æ˜¼/N=å¤œï¼‰ ï¼ 8è¡Œç›®ï¼ç”Ÿç”£æ•° ï¼ Cåˆ—ï¼ä¸è‰¯å†…å®¹ï¼ˆ9ã€œ33è¡Œç›®ï¼‰
      </div>
      <div id="part-btn-area" style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1rem"></div>
      <input type="file" id="part-excel-input" accept=".xlsx,.xls,.xlsm" style="display:none">

      <!-- ãƒ‘ã‚¹æŒ‡å®šå–è¾¼ -->
      <div class="path-import-box">
        <div class="path-import-label" id="path-import-label">ğŸ“ ãƒ‘ã‚¹æŒ‡å®šå–è¾¼ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¸€åº¦è¨­å®š â†’ ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ› â†’ ãƒœã‚¿ãƒ³ä¸€ã¤ã§èª­ã¿è¾¼ã¿ï¼‰</div>
        <div class="path-import-row">
          <button class="btn btn-folder btn-sm" onclick="selectExcelFolder()">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨­å®š</button>
          <div class="path-folder-display" id="excel-folder-path">ãƒ•ã‚©ãƒ«ãƒ€æœªè¨­å®š</div>
        </div>
        <div id="excel-folder-status" style="font-size:0.8rem;color:#c53030;margin:0.3rem 0 0;display:none"></div>
        <div class="path-import-row" style="margin-top:0.5rem">
          <select id="path-part-select"></select>
          <input type="text" id="excel-filename" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: é›†è¨ˆè¡¨.xlsxï¼‰">
          <button class="btn btn-load btn-sm" onclick="loadExcelByFilename()">â–¶ èª­ã¿è¾¼ã‚€</button>
        </div>
      </div>

      <div id="lot-preview-area"></div>
    </div>

    <div class="card">
      <div class="card-title">
        ğŸ“„ ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ï¼ˆå…¨ä»¶ï¼‰
        <button class="btn btn-danger btn-sm" style="margin-left:auto"
                onclick="clearAllRecords()">ğŸ—‘ å…¨ä»¶å‰Šé™¤</button>
      </div>
      <div id="table-all"></div>
    </div>
  </div>

  <!-- ===== Panel: Trend ===== -->
  <div class="panel" id="panel-trend">
    <div class="card">
      <div class="card-title">ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ï¼ˆæ—¥åˆ¥ï¼‰</div>
      <div class="date-range-row">
        <label>æœŸé–“ï¼š</label>
        <input type="date" id="trend-date-from" onchange="renderTrendChart()">
        <span class="tilde">ã€œ</span>
        <input type="date" id="trend-date-to" onchange="renderTrendChart()">
        <button class="btn btn-sm btn-secondary" onclick="clearDateFilter('trend')">å…¨æœŸé–“</button>
      </div>
      <div class="ctrl-row">
        <label>è¡¨ç¤ºï¼š</label>
        <select id="trend-mode" onchange="renderTrendChart()">
          <option value="count">ä¸è‰¯æ•°ï¼ˆä»¶ï¼‰</option>
          <option value="rate">ä¸è‰¯ç‡ï¼ˆ%ï¼‰</option>
        </select>
        <label style="margin-left:0.75rem">ã‚·ãƒ•ãƒˆï¼š</label>
        <select id="trend-shift" onchange="renderTrendChart()">
          <option value="all">å…¨ã¦ï¼ˆæ˜¼ãƒ»å¤œã‚’è‰²åˆ†ã‘ï¼‰</option>
          <option value="æ˜¼">æ˜¼ã®ã¿</option>
          <option value="å¤œ">å¤œã®ã¿</option>
        </select>
      </div>
      <div id="trend-note" style="font-size:0.78rem;color:#a0aec0;margin-bottom:0.75rem;display:none">
        â€» ç”Ÿç”£æ•°ãŒæœªå…¥åŠ›ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆCSVå–è¾¼åˆ†ãªã©ï¼‰ã¯ä¸è‰¯ç‡ã‚’ç®—å‡ºã§ããªã„ãŸã‚é™¤å¤–ã•ã‚Œã¾ã™
      </div>
      <div class="chart-wrap"><canvas id="trend-canvas"></canvas></div>
    </div>
  </div>

  <!-- ===== Panel: Pareto ===== -->
  <div class="panel" id="panel-pareto">
    <div class="card">
      <div class="card-title">ğŸ“Š ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³ï¼ˆä¸è‰¯ç¨®åˆ¥ï¼‰</div>
      <div class="date-range-row">
        <label>æœŸé–“ï¼š</label>
        <input type="date" id="pareto-date-from" onchange="renderParetoChart()">
        <span class="tilde">ã€œ</span>
        <input type="date" id="pareto-date-to" onchange="renderParetoChart()">
        <button class="btn btn-sm btn-secondary" onclick="clearDateFilter('pareto')">å…¨æœŸé–“</button>
      </div>
      <div class="ctrl-row">
        <label>ã‚·ãƒ•ãƒˆï¼š</label>
        <select id="pareto-shift" onchange="renderParetoChart()">
          <option value="all">å…¨ã¦</option>
          <option value="æ˜¼">æ˜¼ã®ã¿</option>
          <option value="å¤œ">å¤œã®ã¿</option>
        </select>
      </div>
      <div class="chart-wrap"><canvas id="pareto-canvas"></canvas></div>
    </div>
  </div>

  <!-- ===== Panel: Analysis ===== -->
  <div class="panel" id="panel-analysis">

    <!-- Date range filter (applies to all charts in this panel) -->
    <div class="card" style="padding:0.85rem 1.25rem">
      <div class="date-range-row" style="margin-bottom:0">
        <label>æœŸé–“ï¼š</label>
        <input type="date" id="analysis-date-from" onchange="renderAnalysisPanel()">
        <span class="tilde">ã€œ</span>
        <input type="date" id="analysis-date-to" onchange="renderAnalysisPanel()">
        <button class="btn btn-sm btn-secondary" onclick="clearDateFilter('analysis')">å…¨æœŸé–“</button>
      </div>
    </div>

    <!-- Shift comparison table -->
    <div class="card">
      <div class="card-title">â˜€ï¸ğŸŒ™ æ˜¼å¤œã‚·ãƒ•ãƒˆæ¯”è¼ƒè¡¨</div>
      <div id="shift-compare-table"></div>
    </div>

    <!-- Control chart -->
    <div class="card">
      <div class="card-title">ğŸ“‰ ç®¡ç†å›³ï¼ˆpç®¡ç†å›³ï¼‰</div>
      <div class="ctrl-row">
        <label>ã‚·ãƒ•ãƒˆï¼š</label>
        <select id="ctrl-shift" onchange="renderControlChart()">
          <option value="all">å…¨ã¦</option>
          <option value="æ˜¼">æ˜¼ã®ã¿</option>
          <option value="å¤œ">å¤œã®ã¿</option>
        </select>
      </div>
      <div id="ctrl-note" style="font-size:0.78rem;color:#718096;margin-bottom:0.75rem;display:none"></div>
      <div class="chart-wrap"><canvas id="ctrl-canvas"></canvas></div>
    </div>

  </div>

  <!-- ===== Panel: Report ===== -->
  <div class="panel" id="panel-report">

    <!-- KPI Comparison Dashboard -->
    <div class="card no-print">
      <div class="card-title">
        ğŸ“Š å‰æ—¥æ¯”ãƒ»é€±æ¬¡æ¯”è¼ƒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        <span style="margin-left:auto;display:flex;align-items:center;gap:0.5rem">
          <label style="font-size:0.82rem;font-weight:600;color:#4a5568">åŸºæº–æ—¥ï¼š</label>
          <input type="date" id="report-date" onchange="renderReport()"
                 style="padding:0.35rem 0.6rem;border:2px solid #e2e8f0;border-radius:8px;font-size:0.85rem;outline:none">
        </span>
      </div>
      <div id="kpi-dashboard"></div>
    </div>

    <!-- Printable Daily Report -->
    <div class="card">
      <div class="card-title print-hide">
        ğŸ“„ å“è³ªæ—¥å ±ãƒ¬ãƒãƒ¼ãƒˆ
        <button class="btn btn-primary btn-sm" onclick="window.print()" style="margin-left:auto">ğŸ–¨ å°åˆ·</button>
      </div>
      <div id="report-content"></div>
    </div>

  </div>

</div><!-- /container -->

<script>
  // ===========================
  //  State
  // ===========================
  const STORAGE_KEY = 'defect-analysis-v2';
  let records = [];
  let trendChart = null;
  let paretoChart = null;
  let ctrlChart   = null;
  let csvPreviewData = [];
  let lotPreviewData = [];
  let currentPartConfig = null;
  let _idCounter = Date.now();

  // ===========================
  //  å“ç•ªåˆ¥å–è¾¼è¨­å®šï¼ˆå¢—ã‚„ã™å ´åˆã¯ã“ã“ã«è¿½è¨˜ï¼‰
  // ===========================
  const PART_CONFIGS = [
    {
      id:           '10L80é›†è¨ˆ',
      label:        '10L80',
      sheetName:    '10L80é›†è¨ˆ',
      rowMold:      6,   // é‡‘å‹ç•ªå·ã®è¡Œï¼ˆ1-indexedï¼‰
      rowLot:       7,   // é‹³é€ ãƒ­ãƒƒãƒˆã®è¡Œï¼ˆ1-indexedï¼‰
      rowProd:      8,   // ç”Ÿç”£æ•°ã®è¡Œï¼ˆ1-indexedï¼‰
      colItem:      3,   // Cåˆ— = ä¸è‰¯å†…å®¹ï¼ˆ1-indexedï¼‰
      rowItemStart: 9,   // ä¸è‰¯é …ç›® é–‹å§‹è¡Œ
      rowItemEnd:   33,  // ä¸è‰¯é …ç›® çµ‚äº†è¡Œ
      colDataStart: 4    // Dåˆ—ã‹ã‚‰å³ãŒãƒ‡ãƒ¼ã‚¿åˆ—ï¼ˆ1-indexedï¼‰
    }
    ,
    {
      id:           'RXO DRUMé›†è¨ˆ',
      label:        'RXO DRUM',
      sheetName:    'è£½é€ 1èª²é›†è¨ˆ',
      rowMold:      null,               // å‹ç•ªè¡Œãªã—
      rowDate:      2,                  // Gåˆ—2è¡Œç›® = åŠ å·¥ãƒ­ãƒƒãƒˆï¼ˆæ—¥ä»˜+ã‚·ãƒ•ãƒˆè§£æï¼‰
      rowLot:       [174, 175, 176, 177, 178], // é‹³é€ ãƒ­ãƒƒãƒˆè¤‡æ•°è¡Œï¼ˆæ··åˆè¡¨ç¤ºï¼‰
      rowProd:      179,                // ç”Ÿç”£æ•°ã®è¡Œï¼ˆ1-indexedï¼‰
      colItem:      3,                  // Cåˆ— = ä¸è‰¯å†…å®¹ï¼ˆ1-indexedï¼‰
      rowItemStart: 48,                 // ä¸è‰¯é …ç›® é–‹å§‹è¡Œ
      rowItemEnd:   90,                 // ä¸è‰¯é …ç›® çµ‚äº†è¡Œ
      colDataStart: 7                   // Gåˆ—ã‹ã‚‰å³ãŒãƒ‡ãƒ¼ã‚¿åˆ—ï¼ˆ1-indexedï¼‰
    }
    // å“ç•ªã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ä¸Šã®å½¢å¼ã§ã“ã“ã«è¿½è¨˜
  ];

  function genId() { return ++_idCounter; }

  // Load & migrate
  try {
    const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) ||
                           localStorage.getItem('defect-analysis-v1') || '[]');
    records = raw.map(r => {
      if (r.shift === undefined) r.shift = null;
      if (!r.source) r.source = 'manual';
      return r;
    });
  } catch(e) { records = []; }

  // ===========================
  //  Boot
  // ===========================
  document.getElementById('inp-date').value = todayStr();
  addDefectRow(); addDefectRow();
  renderAllTables();
  updateStats();
  initDropArea();
  renderPartButtons();
  initPathPartSelect();
  initFolderDisplay();
  // Initialize report date to most recent data date (or today)
  const _rdates = records.map(r => r.date).sort();
  document.getElementById('report-date').value = _rdates.length ? _rdates[_rdates.length - 1] : todayStr();

  // ===========================
  //  Helpers
  // ===========================
  function todayStr() { return new Date().toISOString().split('T')[0]; }

  function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function showAlert(msg, type) {
    const el = document.getElementById('alert');
    el.textContent = msg;
    el.className = 'alert alert-' + type;
    el.style.display = 'block';
    clearTimeout(el._t);
    el._t = setTimeout(() => { el.style.display = 'none'; }, 3500);
  }

  function sortRecords() {
    records.sort((a, b) =>
      a.date.localeCompare(b.date) || (a.shift || '').localeCompare(b.shift || '')
    );
  }

  // åŒåã®ä¸è‰¯ç¨®åˆ¥ã‚’åˆè¨ˆã—ã¦ãƒãƒ¼ã‚¸
  function mergeDefects(existingDefects, newDefects) {
    const map = new Map();
    existingDefects.forEach(d => map.set(d.type, (map.get(d.type) || 0) + d.count));
    newDefects.forEach(d => map.set(d.type, (map.get(d.type) || 0) + d.count));
    return [...map.entries()]
      .map(([type, count]) => ({ type, count }))
      .sort((a, b) => b.count - a.count);
  }

  // ===========================
  //  Tabs
  // ===========================
  const TAB_NAMES = ['input', 'csv', 'trend', 'pareto', 'analysis', 'report'];

  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
      btn.classList.toggle('active', TAB_NAMES[i] === tab);
    });
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-' + tab).classList.add('active');
    if (tab === 'csv')      renderAllTables();
    if (tab === 'trend')    renderTrendChart();
    if (tab === 'pareto')   renderParetoChart();
    if (tab === 'analysis') renderAnalysisPanel();
    if (tab === 'report')   renderReport();
  }

  // ===========================
  //  Manual Input
  // ===========================
  function addDefectRow() {
    const container = document.getElementById('defect-rows');
    const row = document.createElement('div');
    row.className = 'defect-row';
    row.innerHTML =
      '<input type="text" placeholder="ç¨®åˆ¥åï¼ˆä¾‹ï¼šå‚·ã€å¤‰å½¢ã€ç•°ç‰©ï¼‰">' +
      '<input type="number" min="0" placeholder="ä»¶æ•°">' +
      '<button class="btn btn-danger btn-sm" onclick="this.closest(\'.defect-row\').remove()">å‰Šé™¤</button>';
    container.appendChild(row);
    row.querySelector('input').focus();
  }

  function saveRecord() {
    const date = document.getElementById('inp-date').value;
    const shift = document.getElementById('inp-shift').value || null;
    const production = parseInt(document.getElementById('inp-production').value, 10) || null;

    if (!date) return showAlert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');

    const defects = [];
    let totalDefects = 0;
    document.querySelectorAll('#defect-rows .defect-row').forEach(row => {
      const inputs = row.querySelectorAll('input');
      const type = inputs[0].value.trim();
      const count = parseInt(inputs[1].value, 10) || 0;
      if (type && count > 0) { defects.push({ type, count }); totalDefects += count; }
    });

    if (defects.length === 0) return showAlert('ä¸è‰¯ç¨®åˆ¥ã‚’1ä»¶ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„', 'error');

    // åŒã˜æ—¥ä»˜+ã‚·ãƒ•ãƒˆãŒæ—¢ã«ã‚ã‚Œã°åˆè¨ˆã€ãªã‘ã‚Œã°æ–°è¦
    const idx = records.findIndex(r =>
      r.source === 'manual' && r.date === date && r.shift === shift
    );

    let record;
    if (idx >= 0) {
      const existing = records[idx];
      const mergedDefects = mergeDefects(existing.defects, defects);
      const mergedTotal   = mergedDefects.reduce((s, d) => s + d.count, 0);
      const mergedProd    = production || existing.production || null;
      if (mergedProd && mergedTotal > mergedProd) return showAlert('åˆè¨ˆä¸è‰¯æ•°ãŒç”Ÿç”£æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™', 'error');
      record = {
        id: existing.id,
        date, shift,
        production: mergedProd,
        totalDefects: mergedTotal,
        defectRate: mergedProd ? mergedTotal / mergedProd * 100 : null,
        defects: mergedDefects,
        source: 'manual'
      };
      records[idx] = record;
    } else {
      if (production && totalDefects > production) return showAlert('ä¸è‰¯æ•°ãŒç”Ÿç”£æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™', 'error');
      record = {
        id: genId(),
        date, shift, production, totalDefects,
        defectRate: production ? totalDefects / production * 100 : null,
        defects,
        source: 'manual'
      };
      records.push(record);
    }

    sortRecords();
    saveToStorage();
    renderAllTables();
    updateStats();
    resetForm();
    showAlert('âœ“ ä¿å­˜ã—ã¾ã—ãŸ', 'success');
  }

  function resetForm() {
    document.getElementById('inp-date').value = todayStr();
    document.getElementById('inp-shift').value = '';
    document.getElementById('inp-production').value = '';
    document.getElementById('defect-rows').innerHTML = '';
    addDefectRow(); addDefectRow();
  }

  function deleteRecord(id) {
    if (!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    records = records.filter(r => r.id !== id);
    saveToStorage();
    renderAllTables();
    updateStats();
    showAlert('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  }

  // ===========================
  //  Stats
  // ===========================
  function updateStats() {
    const totalDef = records.reduce((s, r) => s + r.totalDefects, 0);
    const types = new Set();
    records.forEach(r => r.defects.forEach(d => types.add(d.type)));

    const withProd = records.filter(r => r.production);
    let rateStr = '--';
    if (withProd.length) {
      const tp = withProd.reduce((s, r) => s + r.production, 0);
      const td = withProd.reduce((s, r) => s + r.totalDefects, 0);
      rateStr = (td / tp * 100).toFixed(2) + '%';
    }

    document.getElementById('stat-records').textContent    = records.length;
    document.getElementById('stat-defects').textContent    = totalDef.toLocaleString();
    document.getElementById('stat-types').textContent      = types.size;
    document.getElementById('stat-defect-rate').textContent = rateStr;
  }

  // ===========================
  //  Table rendering
  // ===========================
  function buildTableHTML(data) {
    if (!data.length) {
      return '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    }
    const rows = data.map(r => {
      const shiftCell = r.shift
        ? '<span class="badge ' + (r.shift === 'æ˜¼' ? 'badge-day' : r.shift === 'å¤œ' ? 'badge-night' : '') + '">' + r.shift + '</span>'
        : '<span style="color:#cbd5e0">--</span>';
      const prodCell = r.production ? r.production.toLocaleString() : '<span style="color:#cbd5e0">--</span>';
      let rateCell = '<span style="color:#cbd5e0">--</span>';
      if (r.defectRate !== null && r.defectRate !== undefined) {
        const bc = r.defectRate >= 5 ? 'badge-ng' : r.defectRate >= 2 ? 'badge-warn' : 'badge-ok';
        rateCell = '<span class="badge ' + bc + '">' + r.defectRate.toFixed(2) + '%</span>';
      }
      const srcBadge = r.source === 'csv'
        ? '<span class="badge badge-csv">CSV</span>'
        : r.source === 'excel'
          ? '<span class="badge badge-excel">' + (r.partNumber || 'Excel') + '</span>'
          : '<span class="badge badge-manual">æ‰‹å‹•</span>';
      const defSum = r.defects.slice(0, 3).map(d => d.type + ':' + d.count).join(', ')
        + (r.defects.length > 3 ? 'â€¦' : '');

      const moldCell = r.moldNumber ? '<span style="font-size:0.78rem;color:#718096">' + r.moldNumber + '</span>' : '';
      return '<tr>' +
        '<td>' + r.date + '</td>' +
        '<td>' + shiftCell + '</td>' +
        '<td>' + moldCell + '</td>' +
        '<td>' + prodCell + '</td>' +
        '<td>' + r.totalDefects.toLocaleString() + '</td>' +
        '<td>' + rateCell + '</td>' +
        '<td style="font-size:0.8rem;color:#718096;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + defSum + '</td>' +
        '<td>' + srcBadge + '</td>' +
        '<td><button class="btn btn-danger btn-sm" onclick="deleteRecord(' + r.id + ')">å‰Šé™¤</button></td>' +
        '</tr>';
    }).join('');

    return '<div class="table-wrap"><table><thead><tr>' +
      '<th>æ—¥ä»˜</th><th>ã‚·ãƒ•ãƒˆ</th><th>é‡‘å‹</th><th>ç”Ÿç”£æ•°</th><th>ä¸è‰¯æ•°</th><th>ä¸è‰¯ç‡</th><th>ç¨®åˆ¥å†…è¨³</th><th>ã‚½ãƒ¼ã‚¹</th><th></th>' +
      '</tr></thead><tbody>' + rows + '</tbody></table></div>';
  }

  function renderAllTables() {
    document.getElementById('table-manual').innerHTML = buildTableHTML(records);
    const allArea = document.getElementById('table-all');
    if (allArea) allArea.innerHTML = buildTableHTML(records);
  }

  // ===========================
  //  CSV Drop area
  // ===========================
  function initDropArea() {
    const drop  = document.getElementById('drop-area');
    const input = document.getElementById('csv-file-input');

    drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('drag-over'); });
    drop.addEventListener('dragleave', ()  => drop.classList.remove('drag-over'));
    drop.addEventListener('drop', e => {
      e.preventDefault();
      drop.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleCSVFile(file);
    });
    input.addEventListener('change', () => {
      if (input.files[0]) handleCSVFile(input.files[0]);
    });
  }

  // ===========================
  //  CSV Parsing
  // ===========================
  function handleCSVFile(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
      showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }
    const encoding = document.getElementById('csv-encoding').value;
    const reader = new FileReader();
    reader.onload = e => processCSVText(e.target.result);
    reader.readAsText(file, encoding);
  }

  function parseCSVLine(line) {
    const fields = [];
    let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ) {
        fields.push(cur.trim()); cur = '';
      } else {
        cur += ch;
      }
    }
    fields.push(cur.trim());
    return fields;
  }

  function normalizeDate(s) {
    s = (s || '').trim();
    let m;
    // YYYY/MM/DD or YYYY-MM-DD or YYYYå¹´MMæœˆDDæ—¥
    if ((m = s.match(/^(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})/))) {
      return m[1] + '-' + m[2].padStart(2, '0') + '-' + m[3].padStart(2, '0');
    }
    // YY/MM/DD (2-digit year)
    if ((m = s.match(/^(\d{2})[\/\-](\d{1,2})[\/\-](\d{1,2})$/))) {
      const y = parseInt(m[1], 10) + (parseInt(m[1], 10) < 50 ? 2000 : 1900);
      return y + '-' + m[2].padStart(2, '0') + '-' + m[3].padStart(2, '0');
    }
    return s;
  }

  function normalizeShift(s) {
    s = (s || '').trim();
    if (/æ˜¼|day|am|æ—¥å‹¤/i.test(s)) return 'æ˜¼';
    if (/å¤œ|night|pm|å¤œå‹¤/i.test(s)) return 'å¤œ';
    return s || 'ä¸æ˜';
  }

  function processCSVText(text) {
    // ç©ºç™½è¡Œã§ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²
    const rawLines = text.split(/\r?\n/);
    const blocks = [];
    let cur = [];
    for (const line of rawLines) {
      if (line.trim() === '') {
        if (cur.length) { blocks.push(cur); cur = []; }
      } else {
        cur.push(line);
      }
    }
    if (cur.length) blocks.push(cur);
    if (!blocks.length) { showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™', 'error'); return; }

    const groups = new Map();  // key: "date|shift"
    let totalDataRows = 0;
    let skipCount = 0;

    blocks.forEach((block, blockIdx) => {
      // ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œå‡ºï¼šå…ˆé ­ãƒ–ãƒ­ãƒƒã‚¯ã®ã¿
      let startRow = 0;
      if (blockIdx === 0) {
        const first = parseCSVLine(block[0]);
        if (first.length >= 4 && isNaN(parseInt(first[3], 10))) startRow = 1;
      }

      // ã“ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã®æƒ…å ±ã‚’åé›†
      let blockProd = null;          // Fåˆ—ã®ç”Ÿç”£æ•°ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰1ã¤å–ã‚‹ï¼‰
      const blockDefects = new Map();
      let blockDate = null, blockShift = null, blockValid = false;

      for (let i = startRow; i < block.length; i++) {
        totalDataRows++;
        const f = parseCSVLine(block[i]);
        if (f.length < 4) { skipCount++; continue; }

        const date  = normalizeDate(f[0]);
        const shift = normalizeShift(f[1]);
        const type  = f[2].trim();
        const count = parseInt(f[3], 10);
        const prod  = parseInt(f[5], 10) || null;  // Fåˆ— = ç·ç”Ÿç”£æ•°

        if (!date || !type || isNaN(count) || count <= 0) { skipCount++; continue; }

        if (!blockDate) { blockDate = date; blockShift = shift; }
        blockDefects.set(type, (blockDefects.get(type) || 0) + count);
        if (!blockProd && prod) blockProd = prod;  // ãƒ–ãƒ­ãƒƒã‚¯å†…ã§1ã¤ã ã‘æ¡ç”¨
        blockValid = true;
      }

      if (!blockValid || !blockDate) return;

      // åŒä¸€ date+shift ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ç´¯ç©
      const key = blockDate + '|' + blockShift;
      if (!groups.has(key)) {
        groups.set(key, { date: blockDate, shift: blockShift, defects: new Map(), total: 0, production: 0 });
      }
      const g = groups.get(key);
      for (const [type, count] of blockDefects) {
        g.defects.set(type, (g.defects.get(type) || 0) + count);
        g.total += count;
      }
      // ç”Ÿç”£æ•°ã¯ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã«1ã¤ãšã¤åˆè¨ˆ
      if (blockProd) g.production += blockProd;
    });

    if (!groups.size) {
      showAlert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
      return;
    }

    csvPreviewData = [];
    for (const [, g] of groups) {
      csvPreviewData.push({
        date: g.date,
        shift: g.shift,
        production: g.production || null,
        totalDefects: g.total,
        defects: [...g.defects.entries()]
          .map(([type, count]) => ({ type, count }))
          .sort((a, b) => b.count - a.count)
      });
    }
    csvPreviewData.sort((a, b) =>
      a.date.localeCompare(b.date) || a.shift.localeCompare(b.shift)
    );

    showCSVPreview(totalDataRows, skipCount);
  }

  function showCSVPreview(totalRows, skipCount) {
    const data = csvPreviewData;
    const area = document.getElementById('csv-preview-area');

    const summary =
      '<div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;padding:0.8rem 1rem;margin-bottom:1rem;font-size:0.875rem;color:#276749">' +
      '<strong>' + totalRows + 'è¡Œ</strong>ã‚’è§£æ â†’ <strong>' + data.length + 'ä»¶</strong>ã®è¨˜éŒ²ã‚’å–è¾¼äºˆå®š' +
      (skipCount > 0 ? ' &nbsp;<span style="color:#744210">ï¼ˆ' + skipCount + 'è¡Œã‚¹ã‚­ãƒƒãƒ—ï¼‰</span>' : '') +
      '</div>';

    const rows = data.slice(0, 30).map(r => {
      const shiftB = r.shift === 'æ˜¼'
        ? '<span class="badge badge-day">æ˜¼</span>'
        : r.shift === 'å¤œ' ? '<span class="badge badge-night">å¤œ</span>' : r.shift;
      const prodCell = r.production ? r.production.toLocaleString() : '<span style="color:#cbd5e0">--</span>';
      const rate = r.production ? (r.totalDefects / r.production * 100).toFixed(2) + '%' : '<span style="color:#cbd5e0">--</span>';
      const defStr = r.defects.slice(0, 4).map(d => d.type + ':' + d.count + 'ä»¶').join('&nbsp;&nbsp;')
        + (r.defects.length > 4 ? '&nbsp;â€¦' : '');
      return '<tr><td>' + r.date + '</td><td>' + shiftB + '</td>' +
        '<td>' + prodCell + '</td>' +
        '<td>' + r.totalDefects.toLocaleString() + '</td>' +
        '<td>' + rate + '</td>' +
        '<td style="font-size:0.8rem;color:#718096">' + defStr + '</td></tr>';
    }).join('');

    const more = data.length > 30
      ? '<p style="text-align:center;color:#a0aec0;font-size:0.8rem;padding:0.75rem">â€¦ä»– ' + (data.length - 30) + ' ä»¶</p>'
      : '';

    area.innerHTML = summary +
      '<div class="table-wrap"><table><thead><tr>' +
      '<th>æ—¥ä»˜</th><th>ã‚·ãƒ•ãƒˆ</th><th>ç”Ÿç”£æ•°</th><th>ä¸è‰¯æ•°</th><th>ä¸è‰¯ç‡</th><th>ç¨®åˆ¥å†…è¨³ï¼ˆä¸Šä½ï¼‰</th>' +
      '</tr></thead><tbody>' + rows + '</tbody></table></div>' + more +
      '<div class="form-actions" style="border-top:none;padding-top:0;margin-top:1rem">' +
      '<button class="btn btn-secondary" onclick="cancelCSVImport()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' +
      '<button class="btn btn-primary" onclick="importCSV()">âœ“ å–è¾¼ç¢ºå®š</button>' +
      '</div>';
  }

  function clearAllRecords() {
    if (!records.length) return showAlert('å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    if (!confirm('å…¨ ' + records.length + ' ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    records = [];
    saveToStorage();
    renderAllTables();
    updateStats();
    showAlert('âœ“ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  }

  function cancelCSVImport() {
    csvPreviewData = [];
    document.getElementById('csv-preview-area').innerHTML = '';
    document.getElementById('csv-file-input').value = '';
  }

  function importCSV() {
    if (!csvPreviewData.length) return;
    let added = 0, updated = 0;
    const base = Date.now();

    csvPreviewData.forEach((p, i) => {
      const idx = records.findIndex(r =>
        r.source === 'csv' && r.date === p.date && r.shift === p.shift
      );
      let rec;
      if (idx >= 0) {
        // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨åˆè¨ˆ
        const existing = records[idx];
        const mergedDefects = mergeDefects(existing.defects, p.defects);
        const mergedTotal   = mergedDefects.reduce((s, d) => s + d.count, 0);
        const mergedProd    = existing.production || p.production || null;
        rec = {
          id: existing.id,
          date: p.date,
          shift: p.shift,
          production: mergedProd,
          totalDefects: mergedTotal,
          defectRate: mergedProd ? mergedTotal / mergedProd * 100 : null,
          defects: mergedDefects,
          source: 'csv'
        };
        records[idx] = rec;
        updated++;
      } else {
        rec = {
          id: base + i,
          date: p.date,
          shift: p.shift,
          production: p.production || null,
          totalDefects: p.totalDefects,
          defectRate: p.production ? p.totalDefects / p.production * 100 : null,
          defects: p.defects,
          source: 'csv'
        };
        records.push(rec);
        added++;
      }
    });

    sortRecords();
    saveToStorage();
    renderAllTables();
    updateStats();
    cancelCSVImport();
    showAlert('âœ“ å–è¾¼å®Œäº†ï¼šæ–°è¦ ' + added + ' ä»¶ã€æ›´æ–° ' + updated + ' ä»¶', 'success');
  }

  // ===========================
  //  Date Range Filter Helpers
  // ===========================
  function getDateFilteredRecords(prefix) {
    const from = document.getElementById(prefix + '-date-from').value;
    const to   = document.getElementById(prefix + '-date-to').value;
    return records.filter(r =>
      (!from || r.date >= from) && (!to || r.date <= to)
    );
  }

  function clearDateFilter(prefix) {
    document.getElementById(prefix + '-date-from').value = '';
    document.getElementById(prefix + '-date-to').value = '';
    if (prefix === 'trend')    renderTrendChart();
    if (prefix === 'pareto')   renderParetoChart();
    if (prefix === 'analysis') renderAnalysisPanel();
  }

  // ===========================
  //  Trend Chart
  // ===========================
  function renderTrendChart() {
    const canvas = document.getElementById('trend-canvas');
    const mode        = document.getElementById('trend-mode').value;    // 'count' | 'rate'
    const shiftFilter = document.getElementById('trend-shift').value;
    const noteEl      = document.getElementById('trend-note');

    const dateFiltered = getDateFilteredRecords('trend');
    const filtered = shiftFilter === 'all'
      ? dateFiltered
      : dateFiltered.filter(r => r.shift === shiftFilter);

    // For rate mode, we need at least one record with production count
    const rateAvailable = filtered.some(r => r.defectRate !== null && r.defectRate !== undefined);
    noteEl.style.display = (mode === 'rate') ? 'block' : 'none';

    if (!filtered.length || (mode === 'rate' && !rateAvailable)) {
      if (trendChart) { trendChart.destroy(); trendChart = null; }
      showChartEmpty(canvas, mode === 'rate'
        ? 'ä¸è‰¯ç‡ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€æ‰‹å‹•å…¥åŠ›ã‚¿ãƒ–ã§ç”Ÿç”£æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
        : 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    hideChartEmpty(canvas);

    // Dates: rate mode uses only records that have defectRate
    const srcRecords = mode === 'rate'
      ? filtered.filter(r => r.defectRate !== null && r.defectRate !== undefined)
      : filtered;
    const allDates = [...new Set(srcRecords.map(r => r.date))].sort();

    // Helper: value for one cell (date Ã— shift)
    function cellValue(recs) {
      if (!recs.length) return null;
      if (mode === 'count') {
        return recs.reduce((s, r) => s + r.totalDefects, 0);
      } else {
        const withRate = recs.filter(r => r.defectRate !== null && r.defectRate !== undefined);
        if (!withRate.length) return null;
        // Weighted average rate when multiple records on same date+shift
        const totProd = withRate.reduce((s, r) => s + (r.production || 0), 0);
        const totDef  = withRate.reduce((s, r) => s + r.totalDefects, 0);
        return totProd > 0
          ? parseFloat((totDef / totProd * 100).toFixed(3))
          : parseFloat((withRate.reduce((s, r) => s + r.defectRate, 0) / withRate.length).toFixed(3));
      }
    }

    const COLOR = { 'æ˜¼': '#f6ad55', 'å¤œ': '#4299e1', 'ãã®ä»–': '#68d391', 'ä¸æ˜': '#a0aec0' };
    let datasets;

    if (shiftFilter === 'all') {
      const shiftKeys = [...new Set(dateFiltered.map(r => r.shift || 'ãã®ä»–'))].sort();
      datasets = shiftKeys.map(sh => ({
        label: sh,
        data: allDates.map(d => cellValue(
          dateFiltered.filter(r => r.date === d && (r.shift || 'ãã®ä»–') === sh)
        )),
        borderColor: COLOR[sh] || '#a0aec0',
        backgroundColor: (COLOR[sh] || '#a0aec0') + '28',
        borderWidth: 2.5,
        pointRadius: 4,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        fill: false,
        tension: 0.3,
        spanGaps: false
      }));
    } else {
      const color = shiftFilter === 'æ˜¼' ? '#f6ad55' : '#4299e1';
      const label = mode === 'count'
        ? 'ä¸è‰¯æ•°ï¼ˆ' + shiftFilter + 'ï¼‰'
        : 'ä¸è‰¯ç‡ï¼ˆ' + shiftFilter + 'ï¼‰';
      datasets = [{
        label,
        data: allDates.map(d => cellValue(filtered.filter(r => r.date === d))),
        borderColor: color,
        backgroundColor: color + '28',
        borderWidth: 2.5,
        pointRadius: 4,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        fill: true,
        tension: 0.3,
        spanGaps: false
      }];
    }

    const yTitle = mode === 'count' ? 'ä¸è‰¯æ•° (ä»¶)' : 'ä¸è‰¯ç‡ (%)';
    const yTicks = mode === 'rate' ? { callback: v => v + '%' } : {};
    const tooltipLabel = mode === 'rate'
      ? ctx => ctx.dataset.label + ': ' + (ctx.parsed.y !== null ? ctx.parsed.y + '%' : '--')
      : ctx => ctx.dataset.label + ': ' + (ctx.parsed.y !== null ? ctx.parsed.y + 'ä»¶' : '--');

    if (trendChart) trendChart.destroy();
    trendChart = new Chart(canvas, {
      type: 'line',
      data: { labels: allDates, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: { label: tooltipLabel }
          }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: yTitle }, ticks: yTicks },
          x: { title: { display: true, text: 'æ—¥ä»˜' } }
        }
      }
    });
  }

  // ===========================
  //  Pareto Chart
  // ===========================
  function renderParetoChart() {
    const canvas = document.getElementById('pareto-canvas');
    const shiftFilter = document.getElementById('pareto-shift').value;
    const dateFiltered = getDateFilteredRecords('pareto');
    const filtered = shiftFilter === 'all' ? dateFiltered : dateFiltered.filter(r => r.shift === shiftFilter);

    const defMap = {};
    filtered.forEach(r => r.defects.forEach(d => {
      defMap[d.type] = (defMap[d.type] || 0) + d.count;
    }));

    if (!Object.keys(defMap).length) {
      if (paretoChart) { paretoChart.destroy(); paretoChart = null; }
      showChartEmpty(canvas, 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    hideChartEmpty(canvas);
    const sorted = Object.entries(defMap).sort((a, b) => b[1] - a[1]);
    const labels = sorted.map(([k]) => k);
    const counts = sorted.map(([, v]) => v);
    const total  = counts.reduce((s, c) => s + c, 0);
    let cum = 0;
    const cumRates = counts.map(c => { cum += c; return parseFloat((cum / total * 100).toFixed(1)); });

    if (paretoChart) paretoChart.destroy();
    paretoChart = new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'ä¸è‰¯ä»¶æ•°',
            data: counts,
            backgroundColor: 'rgba(49,130,206,0.75)',
            borderColor: '#2b6cb0',
            borderWidth: 1,
            yAxisID: 'y',
            order: 2
          },
          {
            label: 'ç´¯ç©æ¯”ç‡ (%)',
            data: cumRates,
            type: 'line',
            borderColor: '#e53e3e',
            backgroundColor: 'transparent',
            borderWidth: 2.5,
            pointBackgroundColor: '#e53e3e',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            yAxisID: 'y2',
            order: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: { beginAtZero: true, position: 'left', title: { display: true, text: 'ä¸è‰¯ä»¶æ•°' } },
          y2: {
            beginAtZero: true, max: 100, position: 'right',
            title: { display: true, text: 'ç´¯ç©æ¯”ç‡ (%)' },
            grid: { drawOnChartArea: false },
            ticks: { callback: v => v + '%' }
          }
        }
      }
    });
  }

  // ===========================
  //  Analysis Panel
  // ===========================
  function renderAnalysisPanel() {
    renderShiftCompareTable();
    renderControlChart();
  }

  // â”€â”€ æ˜¼å¤œã‚·ãƒ•ãƒˆæ¯”è¼ƒè¡¨ â”€â”€
  function renderShiftCompareTable() {
    const area = document.getElementById('shift-compare-table');
    const dateFiltered = getDateFilteredRecords('analysis');
    const allDates = [...new Set(dateFiltered.map(r => r.date))].sort();

    if (!allDates.length) {
      area.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
      return;
    }

    const rows = allDates.map(date => {
      const dayRecs   = dateFiltered.filter(r => r.date === date && r.shift === 'æ˜¼');
      const nightRecs = dateFiltered.filter(r => r.date === date && r.shift === 'å¤œ');

      const dayDef   = dayRecs.reduce((s, r) => s + r.totalDefects, 0);
      const dayProd  = dayRecs.reduce((s, r) => s + (r.production || 0), 0);
      const dayRate  = dayProd > 0 ? dayDef / dayProd * 100 : null;

      const nightDef  = nightRecs.reduce((s, r) => s + r.totalDefects, 0);
      const nightProd = nightRecs.reduce((s, r) => s + (r.production || 0), 0);
      const nightRate = nightProd > 0 ? nightDef / nightProd * 100 : null;

      const dayWorse   = dayRate !== null && nightRate !== null && dayRate > nightRate;
      const nightWorse = dayRate !== null && nightRate !== null && nightRate > dayRate;

      function rateCell(rate, worse) {
        if (rate === null) return '<span style="color:#cbd5e0">--</span>';
        const bc = worse ? 'badge-ng' : 'badge-ok';
        return '<span class="badge ' + bc + '">' + rate.toFixed(2) + '%</span>';
      }
      function numCell(v) { return v > 0 ? v.toLocaleString() : '<span style="color:#cbd5e0">--</span>'; }

      return '<tr>' +
        '<td>' + date + '</td>' +
        '<td>' + numCell(dayDef)  + '</td>' +
        '<td>' + numCell(dayProd) + '</td>' +
        '<td>' + rateCell(dayRate, dayWorse) + '</td>' +
        '<td>' + numCell(nightDef)  + '</td>' +
        '<td>' + numCell(nightProd) + '</td>' +
        '<td>' + rateCell(nightRate, nightWorse) + '</td>' +
        '</tr>';
    }).join('');

    area.innerHTML =
      '<div class="table-wrap"><table><thead>' +
      '<tr>' +
        '<th rowspan="2" style="vertical-align:middle">æ—¥ä»˜</th>' +
        '<th colspan="3" style="text-align:center;background:#fefcbf;border-bottom:1px solid #e2e8f0">â˜€ï¸ æ˜¼</th>' +
        '<th colspan="3" style="text-align:center;background:#ebf4ff;border-bottom:1px solid #e2e8f0">ğŸŒ™ å¤œ</th>' +
      '</tr>' +
      '<tr>' +
        '<th>ä¸è‰¯æ•°</th><th>ç”Ÿç”£æ•°</th><th>ä¸è‰¯ç‡</th>' +
        '<th>ä¸è‰¯æ•°</th><th>ç”Ÿç”£æ•°</th><th>ä¸è‰¯ç‡</th>' +
      '</tr>' +
      '</thead><tbody>' + rows + '</tbody></table></div>';
  }

  // â”€â”€ pç®¡ç†å›³ â”€â”€
  function renderControlChart() {
    const canvas = document.getElementById('ctrl-canvas');
    const shiftFilter = document.getElementById('ctrl-shift').value;
    const noteEl = document.getElementById('ctrl-note');

    const dateFiltered = getDateFilteredRecords('analysis');
    let src = dateFiltered.filter(r => r.production && r.defectRate !== null && r.defectRate !== undefined);
    if (shiftFilter !== 'all') src = src.filter(r => r.shift === shiftFilter);
    src.sort((a, b) => a.date.localeCompare(b.date) || (a.shift || '').localeCompare(b.shift || ''));

    if (src.length < 2) {
      if (ctrlChart) { ctrlChart.destroy(); ctrlChart = null; }
      noteEl.style.display = 'none';
      showChartEmpty(canvas, src.length === 0
        ? 'ç”Ÿç”£æ•°ãŒå…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆCSVå–è¾¼ã§Fåˆ—ã€ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›ã§ç”Ÿç”£æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰'
        : 'ç®¡ç†å›³ã«ã¯2ä»¶ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™');
      return;
    }
    hideChartEmpty(canvas);

    // pÌ„ï¼ˆå…¨ä½“å¹³å‡ä¸è‰¯ç‡ï¼‰
    const totProd = src.reduce((s, r) => s + r.production, 0);
    const totDef  = src.reduce((s, r) => s + r.totalDefects, 0);
    const pBar    = totDef / totProd;

    const labels = src.map(r => r.date + (r.shift ? ' ' + r.shift : ''));
    const rates  = src.map(r => parseFloat(r.defectRate.toFixed(3)));

    // å„ç‚¹ã® UCL / LCLï¼ˆn ãŒç•°ãªã‚‹ãŸã‚ç‚¹ã”ã¨ã«è¨ˆç®—ï¼‰
    const ucls = src.map(r => {
      const s = Math.sqrt(pBar * (1 - pBar) / r.production);
      return parseFloat(Math.min(100, (pBar + 3 * s) * 100).toFixed(3));
    });
    const lcls = src.map(r => {
      const s = Math.sqrt(pBar * (1 - pBar) / r.production);
      return parseFloat(Math.max(0, (pBar - 3 * s) * 100).toFixed(3));
    });
    const center = src.map(() => parseFloat((pBar * 100).toFixed(3)));

    // ç®¡ç†å¤–ã‚Œåˆ¤å®š
    const isOut = src.map((r, i) => r.defectRate > ucls[i] || r.defectRate < lcls[i]);
    const ptColors = isOut.map(o => o ? '#e53e3e' : '#3182ce');
    const ptRadius = isOut.map(o => o ? 7 : 4);
    const outCount = isOut.filter(Boolean).length;

    noteEl.textContent =
      'pÌ„ï¼ˆä¸­å¿ƒç·šï¼‰= ' + (pBar * 100).toFixed(3) + '%ã€€UCL = pÌ„ + 3Ïƒã€€LCL = pÌ„ âˆ’ 3Ïƒï¼ˆÏƒ ã¯å„ç‚¹ã®nã§ç®—å‡ºï¼‰' +
      (outCount > 0 ? 'ã€€âš ï¸ ç®¡ç†å¤–ã‚Œ ' + outCount + ' ç‚¹ï¼ˆèµ¤ä¸¸ï¼‰' : 'ã€€âœ“ å…¨ç‚¹ç®¡ç†å†…');
    noteEl.style.color = outCount > 0 ? '#c53030' : '#276749';
    noteEl.style.display = 'block';

    if (ctrlChart) ctrlChart.destroy();
    ctrlChart = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'ä¸è‰¯ç‡',
            data: rates,
            borderColor: '#3182ce',
            backgroundColor: 'transparent',
            borderWidth: 2,
            pointBackgroundColor: ptColors,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: ptRadius,
            fill: false,
            tension: 0,
            order: 1
          },
          {
            label: 'UCLï¼ˆä¸Šé™ï¼‰',
            data: ucls,
            borderColor: '#e53e3e',
            backgroundColor: 'transparent',
            borderWidth: 1.5,
            borderDash: [5, 4],
            pointRadius: 0,
            fill: false,
            tension: 0,
            order: 2
          },
          {
            label: 'ä¸­å¿ƒç·š (pÌ„)',
            data: center,
            borderColor: '#38a169',
            backgroundColor: 'transparent',
            borderWidth: 1.5,
            borderDash: [8, 4],
            pointRadius: 0,
            fill: false,
            tension: 0,
            order: 3
          },
          {
            label: 'LCLï¼ˆä¸‹é™ï¼‰',
            data: lcls,
            borderColor: '#dd6b20',
            backgroundColor: 'transparent',
            borderWidth: 1.5,
            borderDash: [5, 4],
            pointRadius: 0,
            fill: false,
            tension: 0,
            order: 4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.y;
                if (ctx.datasetIndex === 0) {
                  return 'ä¸è‰¯ç‡: ' + v + '%' + (isOut[ctx.dataIndex] ? ' âš ï¸ ç®¡ç†å¤–' : '');
                }
                return ctx.dataset.label + ': ' + v + '%';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'ä¸è‰¯ç‡ (%)' },
            ticks: { callback: v => v + '%' }
          },
          x: { title: { display: true, text: 'æ—¥ä»˜ï¼ˆã‚·ãƒ•ãƒˆï¼‰' } }
        }
      }
    });
  }

  // ===========================
  //  Report Tab
  // ===========================
  function prevCalendarDay(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    d.setDate(d.getDate() - 1);
    return d.toISOString().split('T')[0];
  }

  function getWeekRange(dateStr, weekOffset) {
    const d = new Date(dateStr + 'T00:00:00');
    const dow = d.getDay();
    const mon = new Date(d);
    mon.setDate(d.getDate() - (dow === 0 ? 6 : dow - 1) + weekOffset * 7);
    return { start: mon.toISOString().split('T')[0] };
  }

  function calcMetrics(recs) {
    const totalDef  = recs.reduce((s, r) => s + r.totalDefects, 0);
    const totalProd = recs.reduce((s, r) => s + (r.production || 0), 0);
    return { totalDef, totalProd, rate: totalProd > 0 ? totalDef / totalProd * 100 : null };
  }

  function renderReport() {
    const dateEl = document.getElementById('report-date');
    const date = dateEl.value || todayStr();
    if (!dateEl.value) dateEl.value = date;
    renderKPIDashboard(date);
    renderDailyReportContent(date);
  }

  function renderKPIDashboard(date) {
    const area = document.getElementById('kpi-dashboard');
    const todayRecs    = records.filter(r => r.date === date);
    const yestDate     = prevCalendarDay(date);
    const yestRecs     = records.filter(r => r.date === yestDate);
    const todayM       = calcMetrics(todayRecs);
    const yestM        = calcMetrics(yestRecs);
    const todayDayM    = calcMetrics(todayRecs.filter(r => r.shift === 'æ˜¼'));
    const todayNightM  = calcMetrics(todayRecs.filter(r => r.shift === 'å¤œ'));
    const yestDayM     = calcMetrics(yestRecs.filter(r => r.shift === 'æ˜¼'));
    const yestNightM   = calcMetrics(yestRecs.filter(r => r.shift === 'å¤œ'));

    const thisWeek     = getWeekRange(date, 0);
    const thisWeekRecs = records.filter(r => r.date >= thisWeek.start && r.date <= date);
    const thisWeekM    = calcMetrics(thisWeekRecs);

    const lastWeek     = getWeekRange(date, -1);
    const dObj         = new Date(date + 'T00:00:00');
    const daysFromMon  = dObj.getDay() === 0 ? 6 : dObj.getDay() - 1;
    const lwEnd        = new Date(lastWeek.start + 'T00:00:00');
    lwEnd.setDate(lwEnd.getDate() + daysFromMon);
    const lastWeekRecs = records.filter(r => r.date >= lastWeek.start && r.date <= lwEnd.toISOString().split('T')[0]);
    const lastWeekM    = calcMetrics(lastWeekRecs);

    function chgTag(curr, prev) {
      if (curr === null || prev === null)
        return '<span style="color:#a0aec0;font-size:0.78rem">æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—</span>';
      const d = curr - prev;
      if (Math.abs(d) < 0.001) return '<span style="color:#718096;font-size:0.78rem">â€• å¤‰åŒ–ãªã—</span>';
      const col = d > 0 ? '#c53030' : '#276749';
      return '<span style="color:' + col + ';font-weight:700;font-size:0.85rem">' +
             (d > 0 ? 'â–² +' : 'â–¼ ') + d.toFixed(2) + '%</span>';
    }

    function kCard(icon, title, m, compM, compLabel, border) {
      return '<div class="kpi-card" style="border-top:4px solid ' + border + '">' +
        '<div style="font-size:1.3rem;margin-bottom:0.3rem">' + icon + '</div>' +
        '<div class="kpi-title">' + title + '</div>' +
        '<div class="kpi-value" style="color:' + border + '">' + (m.rate !== null ? m.rate.toFixed(2) + '%' : '--') + '</div>' +
        '<div style="font-size:0.73rem;color:#a0aec0;margin:0.15rem 0 0.4rem">' +
          (m.totalProd > 0 ? m.totalProd.toLocaleString() + 'å€‹' : '--') + ' / ä¸è‰¯ ' + m.totalDef + 'ä»¶' +
        '</div>' +
        '<div style="font-size:0.7rem;color:#a0aec0">' + compLabel + '</div>' +
        '<div>' + chgTag(m.rate, compM.rate) + '</div></div>';
    }

    const tc = todayM.rate !== null && todayM.rate >= 5 ? '#e53e3e'
             : todayM.rate !== null && todayM.rate >= 2 ? '#dd6b20' : '#38a169';
    area.innerHTML =
      '<div class="kpi-grid">' +
      kCard('ğŸ“Š', 'å½“æ—¥ä¸è‰¯ç‡',     todayM,      yestM,      'å‰æ—¥æ¯”',     tc) +
      kCard('â˜€ï¸',  'æ˜¼ã‚·ãƒ•ãƒˆä¸è‰¯ç‡', todayDayM,   yestDayM,   'å‰æ—¥æ˜¼æ¯”',   '#f6ad55') +
      kCard('ğŸŒ™',  'å¤œã‚·ãƒ•ãƒˆä¸è‰¯ç‡', todayNightM, yestNightM, 'å‰æ—¥å¤œæ¯”',   '#4299e1') +
      kCard('ğŸ“…', 'é€±æ¬¡å¹³å‡ä¸è‰¯ç‡', thisWeekM,   lastWeekM,  'å…ˆé€±åŒæœŸæ¯”', '#805ad5') +
      '</div>';
  }

  function renderDailyReportContent(date) {
    const area = document.getElementById('report-content');
    const recs = records.filter(r => r.date === date);
    if (!recs.length) {
      area.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>' +
        date + ' ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:0.8rem">ä¸Šã®ã€ŒåŸºæº–æ—¥ã€ã§åˆ¥ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</span></p></div>';
      return;
    }
    const M      = calcMetrics(recs);
    const dayM   = calcMetrics(recs.filter(r => r.shift === 'æ˜¼'));
    const nightM = calcMetrics(recs.filter(r => r.shift === 'å¤œ'));

    const defMap = new Map();
    recs.forEach(r => r.defects.forEach(d => defMap.set(d.type, (defMap.get(d.type) || 0) + d.count)));
    const sdefs = [...defMap.entries()].sort((a, b) => b[1] - a[1]);

    const DOW = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const dateLabel = date + ' (' + DOW[new Date(date + 'T00:00:00').getDay()] + ')';
    const yestDate  = prevCalendarDay(date);
    const yestM     = calcMetrics(records.filter(r => r.date === yestDate));

    function rs(rate) {
      return rate === null ? 'color:#a0aec0'
           : rate >= 5 ? 'color:#c53030;font-weight:bold'
           : rate >= 2 ? 'color:#c05621;font-weight:bold'
           : 'color:#276749;font-weight:bold';
    }
    function fr(rate) { return rate !== null ? rate.toFixed(2) + '%' : '--'; }
    function fn(n) { return n > 0 ? n.toLocaleString() : '--'; }

    // Summary KPI cards
    let kpiH = '';
    [{l:'ç·ç”Ÿç”£æ•°', v:fn(M.totalProd),              u:'å€‹', s:'color:#2b6cb0'},
     {l:'ç·ä¸è‰¯æ•°', v:M.totalDef.toLocaleString(),   u:'ä»¶', s:'color:#276749'},
     {l:'ä¸è‰¯ç‡',   v:M.rate!==null?M.rate.toFixed(2):'--', u:'%', s:rs(M.rate)}
    ].forEach(k => {
      kpiH += '<div style="background:#f7fafc;border-radius:8px;padding:0.85rem;text-align:center">' +
        '<div style="font-size:0.7rem;color:#718096;font-weight:600;text-transform:uppercase;letter-spacing:0.06em">' + k.l + '</div>' +
        '<div style="font-size:1.6rem;font-weight:800;' + k.s + ';margin-top:0.2rem">' + k.v +
        '<span style="font-size:0.85rem">' + k.u + '</span></div></div>';
    });

    // Shift table rows
    let shiftH = '';
    [{lbl:'â˜€ï¸ æ˜¼', m:dayM,   bg:'#fefcbf', b:false},
     {lbl:'ğŸŒ™ å¤œ', m:nightM, bg:'#ebf4ff', b:false},
     {lbl:'åˆè¨ˆ',  m:M,      bg:'#f7fafc', b:true}
    ].forEach(row => {
      shiftH += '<tr style="background:' + row.bg + '">' +
        '<td style="padding:0.55rem 0.85rem;' + (row.b ? 'font-weight:700' : '') + '">' + row.lbl + '</td>' +
        '<td style="padding:0.55rem 0.85rem;text-align:right">' + fn(row.m.totalProd) + '</td>' +
        '<td style="padding:0.55rem 0.85rem;text-align:right">' + row.m.totalDef.toLocaleString() + '</td>' +
        '<td style="padding:0.55rem 0.85rem;text-align:right;' + rs(row.m.rate) + '">' + fr(row.m.rate) + '</td></tr>';
    });

    // Defect ranking rows
    let defH = '';
    sdefs.slice(0, 10).forEach((e, i) => {
      const pct = M.totalDef > 0 ? (e[1] / M.totalDef * 100).toFixed(1) : '0';
      const bar = sdefs[0][1] > 0 ? Math.round(e[1] / sdefs[0][1] * 100) : 0;
      defH += '<tr>' +
        '<td style="padding:0.55rem 0.85rem;text-align:center;color:#718096">' + (i + 1) + '</td>' +
        '<td style="padding:0.55rem 0.85rem"><strong>' + e[0] + '</strong></td>' +
        '<td style="padding:0.55rem 0.85rem;text-align:right">' + e[1].toLocaleString() + '</td>' +
        '<td style="padding:0.55rem 0.85rem;text-align:right">' + pct + '%</td>' +
        '<td style="padding:0.55rem 0.85rem"><div style="background:#e2e8f0;border-radius:4px;height:10px">' +
        '<div style="background:#3182ce;border-radius:4px;height:10px;width:' + bar + '%"></div></div></td></tr>';
    });

    // Yesterday comparison block
    let yestH = '';
    if (yestM.rate !== null && M.rate !== null) {
      const diff = M.rate - yestM.rate;
      const dLabel = Math.abs(diff) < 0.001
        ? '<span style="color:#718096">å¤‰åŒ–ãªã—</span>'
        : diff > 0
          ? '<span style="color:#c53030;font-weight:bold">â–² +' + diff.toFixed(2) + '% ï¼ˆæ‚ªåŒ–ï¼‰</span>'
          : '<span style="color:#276749;font-weight:bold">â–¼ ' + diff.toFixed(2) + '% ï¼ˆæ”¹å–„ï¼‰</span>';
      yestH = '<div style="background:#f0f9ff;border:1px solid #bee3f8;border-radius:8px;' +
        'padding:0.85rem 1rem;margin-top:1rem;font-size:0.875rem;color:#2a4365">' +
        '<strong>å‰æ—¥ï¼ˆ' + yestDate + 'ï¼‰æ¯”è¼ƒï¼š</strong>ä¸è‰¯ç‡ ' + fr(yestM.rate) + ' â†’ ' + fr(M.rate) + 'ã€€' + dLabel + '</div>';
    }

    const th = 'style="background:#f7fafc;padding:0.5rem 0.85rem;text-align:';
    area.innerHTML =
      '<div class="print-report">' +
      // Header
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:2px solid #2b6cb0">' +
      '<div><div style="font-size:1.3rem;font-weight:800;color:#1a202c">å“è³ªæ—¥å ±</div>' +
      '<div style="font-size:0.85rem;color:#718096;margin-top:0.2rem">QUALITY DAILY REPORT</div></div>' +
      '<div style="text-align:right"><div style="font-size:1.1rem;font-weight:700;color:#2b6cb0">' + dateLabel + '</div>' +
      '<div style="font-size:0.78rem;color:#a0aec0;margin-top:0.1rem">ä½œæˆï¼š' +
        new Date().toLocaleString('ja-JP', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}) +
      '</div></div></div>' +
      // KPI cards
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.25rem">' + kpiH + '</div>' +
      // Shift table
      '<div style="margin-bottom:1.25rem">' +
      '<div style="font-size:0.78rem;font-weight:700;color:#4a5568;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.6rem">ã‚·ãƒ•ãƒˆåˆ¥å®Ÿç¸¾</div>' +
      '<table style="width:100%;border-collapse:collapse;font-size:0.875rem"><thead><tr>' +
      '<th ' + th + 'left;border-bottom:2px solid #e2e8f0">ã‚·ãƒ•ãƒˆ</th>' +
      '<th ' + th + 'right;border-bottom:2px solid #e2e8f0">ç”Ÿç”£æ•°</th>' +
      '<th ' + th + 'right;border-bottom:2px solid #e2e8f0">ä¸è‰¯æ•°</th>' +
      '<th ' + th + 'right;border-bottom:2px solid #e2e8f0">ä¸è‰¯ç‡</th>' +
      '</tr></thead><tbody>' + shiftH + '</tbody></table></div>' +
      // Defect ranking
      '<div style="margin-bottom:1rem">' +
      '<div style="font-size:0.78rem;font-weight:700;color:#4a5568;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.6rem">ä¸è‰¯ç¨®åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>' +
      '<table style="width:100%;border-collapse:collapse;font-size:0.875rem"><thead><tr>' +
      '<th ' + th + 'center;border-bottom:2px solid #e2e8f0;width:3rem">é †ä½</th>' +
      '<th ' + th + 'left;border-bottom:2px solid #e2e8f0">ä¸è‰¯å†…å®¹</th>' +
      '<th ' + th + 'right;border-bottom:2px solid #e2e8f0">ä»¶æ•°</th>' +
      '<th ' + th + 'right;border-bottom:2px solid #e2e8f0">æ§‹æˆæ¯”</th>' +
      '<th ' + th + 'left;border-bottom:2px solid #e2e8f0;min-width:100px">æ¯”ç‡</th>' +
      '</tr></thead><tbody>' + defH + '</tbody></table></div>' +
      yestH + '</div>';
  }

  // ===========================
  //  å“ç•ªåˆ¥ Excel ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå–è¾¼
  // ===========================

  // é‹³é€ ãƒ­ãƒƒãƒˆã‚»ãƒ«å€¤ â†’ {date:"YYYY-MM-DD", shift:"æ˜¼"|"å¤œ"|""} or null
  function xlParseHeaderCell(raw) {
    if (raw === null || raw === undefined) return null;
    const curYear = new Date().getFullYear();
    let shift = '', datePart = '';

    // SheetJS(cellDates:true) ã§ã¯æœ¬ç‰©ã®Excelæ—¥ä»˜ã¯Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã‚‹ã€‚
    // æ•°å€¤å‹ã¯ãƒ©ãƒ³ã‚¯ç•ªå·ãƒ»ç®¡ç†ç•ªå·ãªã©ã®éæ—¥ä»˜ã‚»ãƒ«ãªã®ã§ null ã‚’è¿”ã™ã€‚
    if (raw instanceof Date) {
      const d = raw;
      return {
        date: d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'),
        shift: ''
      };
    }
    if (typeof raw === 'number') return null; // æ•°å€¤å‹ = æ—¥ä»˜ã§ã¯ãªã„ï¼ˆãƒ©ãƒ³ã‚¯ç•ªå·ãªã©ï¼‰

    const s = String(raw).trim();
    if (!s) return null;

    const last = s.slice(-1).toUpperCase();
    if      (last === 'D') { shift = 'æ˜¼'; datePart = s.slice(0, -1).trim(); }
    else if (last === 'N') { shift = 'å¤œ'; datePart = s.slice(0, -1).trim(); }
    else                   { datePart = s; }

    // YYYY/M/D or YYYY-M-D
    let m = datePart.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if (m) return { date: m[1] + '-' + m[2].padStart(2, '0') + '-' + m[3].padStart(2, '0'), shift };

    // M/D
    m = datePart.match(/^([0-1]?\d)\/([0-3]?\d)$/);
    if (m) {
      const mm = parseInt(m[1], 10), dd = parseInt(m[2], 10);
      if (mm >= 1 && mm <= 12 && dd >= 1 && dd <= 31) {
        let year = curYear;
        if (new Date(year, mm - 1, dd) > new Date()) year = curYear - 1;
        return { date: year + '-' + String(mm).padStart(2, '0') + '-' + String(dd).padStart(2, '0'), shift };
      }
    }

    // NæœˆNæ—¥
    m = datePart.match(/^([0-1]?\d)æœˆ([0-3]?\d)æ—¥$/);
    if (m) {
      const mm = parseInt(m[1], 10), dd = parseInt(m[2], 10);
      if (mm >= 1 && mm <= 12 && dd >= 1 && dd <= 31) {
        let year = curYear;
        if (new Date(year, mm - 1, dd) > new Date()) year = curYear - 1;
        return { date: year + '-' + String(mm).padStart(2, '0') + '-' + String(dd).padStart(2, '0'), shift };
      }
    }

    // æ—¥ã®ã¿ï¼ˆä¾‹: "8D" â†’ shift='æ˜¼', datePart="8" ã®ã‚ˆã†ã«ã‚·ãƒ•ãƒƒãƒˆä»˜ãã®å ´åˆã®ã¿é©ç”¨ï¼‰
    // ã‚·ãƒ•ãƒƒãƒˆãªã— ("1", "2" ãªã©ã®ç´”ç²‹ãªæ•°å­—æ–‡å­—åˆ—) ã¯èª¤è§£æé˜²æ­¢ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
    if (shift) {
      m = datePart.match(/^(\d{1,2})$/);
      if (m) {
        const dd = parseInt(m[1], 10);
        const now = new Date();
        if (dd >= 1 && dd <= 31)
          return { date: now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(dd).padStart(2, '0'), shift };
      }
    }
    return null;
  }

  function xlToInt(v) {
    if (v === null || v === undefined) return 0;
    if (typeof v === 'number') return Math.round(v);
    const s = String(v).trim().replace(/,/g, '');
    if (!s || s === '-' || s === 'N/A') return 0;
    const n = parseFloat(s);
    return isNaN(n) ? 0 : Math.round(n);
  }

  // PART_CONFIGS ã«åŸºã¥ã„ã¦ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã—ã€ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’åˆæœŸåŒ–
  function renderPartButtons() {
    const area = document.getElementById('part-btn-area');
    area.innerHTML = PART_CONFIGS.map(c =>
      '<button class="btn btn-excel" onclick="triggerPartImport(\'' + c.id + '\')">' +
      'ğŸ“Š ' + c.label + 'ã€€å–è¾¼</button>'
    ).join('');

    document.getElementById('part-excel-input').addEventListener('change', function() {
      if (this.files[0] && currentPartConfig) handlePartExcelFile(this.files[0]);
    });
  }

  function triggerPartImport(configId) {
    currentPartConfig = PART_CONFIGS.find(c => c.id === configId) || null;
    if (!currentPartConfig) return;
    const inp = document.getElementById('part-excel-input');
    inp.value = '';
    inp.click();
  }

  function handlePartExcelFile(file) {
    const name = file.name.toLowerCase();
    if (!name.endsWith('.xlsx') && !name.endsWith('.xls') && !name.endsWith('.xlsm')) {
      showAlert('Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx / .xlsï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }
    if (typeof XLSX === 'undefined') {
      showAlert('SheetJSãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„', 'error');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      try { processPartExcel(e.target.result, currentPartConfig); }
      catch (err) { showAlert('Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error'); }
    };
    reader.readAsArrayBuffer(file);
  }

  function processPartExcel(arrayBuffer, cfg) {
    const wb = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });

    if (!wb.SheetNames.includes(cfg.sheetName)) {
      showAlert('ã‚·ãƒ¼ãƒˆã€Œ' + cfg.sheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
    const ws = wb.Sheets[cfg.sheetName];
    const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
    const maxCol = range.e.c + 1; // 1-indexed

    // Cåˆ—(colItem)ã® rowItemStartã€œrowItemEnd ã‹ã‚‰ä¸è‰¯å†…å®¹åã‚’åé›†
    // ã€Œåˆè¨ˆã€ã€Œå°è¨ˆã€ã€Œè¨ˆã€ã‚’å«ã‚€è¡Œãƒ»æ•°å€¤ã®ã¿ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆäºŒé‡ã‚«ã‚¦ãƒ³ãƒˆé˜²æ­¢ï¼‰
    const itemNames = [];
    for (let r = cfg.rowItemStart; r <= cfg.rowItemEnd; r++) {
      const addr = XLSX.utils.encode_cell({ r: r - 1, c: cfg.colItem - 1 });
      const cell = ws[addr];
      const text = (cell && cell.v) ? String(cell.v).trim() : null;
      const isSummary = text && (
        text.includes('åˆè¨ˆ') ||
        text.includes('å°è¨ˆ') ||
        text.endsWith('è¨ˆ') ||
        text.startsWith('%') ||
        /^\d+$/.test(text)
      );
      itemNames.push(isSummary ? null : text);
    }

    const results = [];
    for (let c = cfg.colDataStart; c <= maxCol; c++) {
      // é‡‘å‹ç•ªå· (rowMold) â”€ null ãªã‚‰ç©ºæ–‡å­—ã§ã‚¹ã‚­ãƒƒãƒ—
      let moldNumber = '';
      if (cfg.rowMold) {
        const moldAddr = XLSX.utils.encode_cell({ r: cfg.rowMold - 1, c: c - 1 });
        moldNumber = (ws[moldAddr] && ws[moldAddr].v !== null) ? String(ws[moldAddr].v).trim() : '';
      }

      // æ—¥ä»˜+ã‚·ãƒ•ãƒˆè§£æ:
      // cfg.rowDate ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã®è¡Œã‚’å„ªå…ˆï¼ˆåŠ å·¥ãƒ­ãƒƒãƒˆè¡Œï¼‰ã€‚
      // æœªæŒ‡å®šã®å ´åˆã¯ rowLot ã®å„è¡Œã‚’é †ã«è©¦ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
      let parsed = null;
      if (cfg.rowDate) {
        const dateAddr = XLSX.utils.encode_cell({ r: cfg.rowDate - 1, c: c - 1 });
        parsed = xlParseHeaderCell(ws[dateAddr] ? ws[dateAddr].v : null);
      }

      // é‹³é€ ãƒ­ãƒƒãƒˆè¡¨ç¤ºç”¨ ID (rowLot) â”€ å˜ä¸€è¡Œ or è¤‡æ•°è¡Œé…åˆ—ã«å¯¾å¿œ
      // è¤‡æ•°è¡Œã®å ´åˆ: å„è¡Œã®å€¤ã‚’ " / " ã§ã¤ãªã’ã¦æ··åˆè¡¨ç¤º
      const rowLots = Array.isArray(cfg.rowLot) ? cfg.rowLot : [cfg.rowLot];
      const lotParts = [];
      for (const rowL of rowLots) {
        const addr = XLSX.utils.encode_cell({ r: rowL - 1, c: c - 1 });
        const raw  = ws[addr] ? ws[addr].v : null;
        if (raw !== null && raw !== undefined) {
          const rawStr = String(raw).trim();
          if (rawStr) lotParts.push(rawStr);
          if (!parsed) parsed = xlParseHeaderCell(raw); // rowDate æœªæŒ‡å®šæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
      }
      const lotId = lotParts.join(' / ');
      if (!parsed || !parsed.date) continue; // æ—¥ä»˜ãªã—åˆ—ã¯ã‚¹ã‚­ãƒƒãƒ—

      // ç”Ÿç”£æ•° (rowProd)
      const prodAddr   = XLSX.utils.encode_cell({ r: cfg.rowProd - 1, c: c - 1 });
      const production = xlToInt(ws[prodAddr] ? ws[prodAddr].v : null);

      // ä¸è‰¯ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
      let totalDefects = 0;
      const defects = [];
      for (let i = 0; i < itemNames.length; i++) {
        const itemName = itemNames[i];
        if (!itemName) continue;
        const r = cfg.rowItemStart + i;
        const cntAddr = XLSX.utils.encode_cell({ r: r - 1, c: c - 1 });
        const cnt = xlToInt(ws[cntAddr] ? ws[cntAddr].v : null);
        if (cnt > 0) { defects.push({ type: itemName, count: cnt }); totalDefects += cnt; }
      }

      if (totalDefects === 0 && production === 0) continue; // ç©ºåˆ—ã‚¹ã‚­ãƒƒãƒ—

      results.push({
        date:         parsed.date,
        shift:        parsed.shift,
        production:   production || null,
        totalDefects,
        defects:      defects.sort((a, b) => b.count - a.count),
        partNumber:   cfg.label,
        moldNumber,
        lotId
      });
    }

    if (!results.length) {
      showAlert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚·ãƒ¼ãƒˆã®æ§‹æˆã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
      return;
    }
    lotPreviewData = results;
    showLotPreview(cfg);
  }

  function showLotPreview(cfg) {
    const colCount = lotPreviewData.length; // Excelã®åˆ—æ•°ï¼ˆãƒ‘ãƒ¬ãƒƒãƒˆå˜ä½ï¼‰

    // å–è¾¼ç¢ºå®šã¨åŒã˜é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    // åŒä¸€ãƒ­ãƒƒãƒˆï¼ˆå“ç•ª+é‡‘å‹+æ—¥ä»˜+ã‚·ãƒ•ãƒˆï¼‰ã¯ç”Ÿç”£æ•°ã‚’åˆç®—ã€ä¸è‰¯ã¯ç¨®åˆ¥ã”ã¨ã«åˆç®—
    const batchMap = new Map();
    for (const p of lotPreviewData) {
      const key = p.partNumber + '|' + p.moldNumber + '|' + p.date + '|' + p.shift;
      if (batchMap.has(key)) {
        const g = batchMap.get(key);
        const merged = mergeDefects(g.defects, p.defects);
        const tot    = merged.reduce((s, d) => s + d.count, 0);
        const prod   = (g.production || 0) + (p.production || 0);
        g.defects      = merged;
        g.totalDefects = tot;
        g.production   = prod || null;
      } else {
        batchMap.set(key, { ...p });
      }
    }
    const data = [...batchMap.values()].sort((a, b) =>
      a.date.localeCompare(b.date) || a.shift.localeCompare(b.shift)
    );

    const area = document.getElementById('lot-preview-area');
    const mergedNote = colCount > data.length
      ? '&nbsp;<span style="color:#744210">ï¼ˆ' + colCount + 'åˆ— â†’ åŒä¸€ãƒ­ãƒƒãƒˆåˆç®—ã§ ' + data.length + 'ä»¶ï¼‰</span>'
      : '';
    const summary =
      '<div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;padding:0.8rem 1rem;margin-bottom:1rem;font-size:0.875rem;color:#276749">' +
      'ã€Œ' + cfg.sheetName + 'ã€ã‹ã‚‰ <strong>' + data.length + 'ä»¶</strong>ã®è¨˜éŒ²ã‚’å–è¾¼äºˆå®š' + mergedNote +
      '</div>';

    const rows = data.map(r => {
      const shiftB = r.shift === 'æ˜¼'
        ? '<span class="badge badge-day">æ˜¼</span>'
        : r.shift === 'å¤œ' ? '<span class="badge badge-night">å¤œ</span>' : (r.shift || '--');
      const prod   = r.production || 0;
      const prodCell = prod ? prod.toLocaleString() : '<span style="color:#cbd5e0">--</span>';
      const rate = prod ? (r.totalDefects / prod * 100).toFixed(2) + '%' : '<span style="color:#cbd5e0">--</span>';
      const defStr = r.defects.slice(0, 3).map(d => d.type + ':' + d.count).join('&nbsp;')
        + (r.defects.length > 3 ? '&nbsp;â€¦' : '');
      return '<tr>' +
        '<td>' + r.date + '</td>' +
        '<td>' + shiftB + '</td>' +
        '<td>' + (r.moldNumber || '--') + '</td>' +
        '<td>' + prodCell + '</td>' +
        '<td>' + r.totalDefects.toLocaleString() + '</td>' +
        '<td>' + rate + '</td>' +
        '<td style="font-size:0.8rem;color:#718096">' + defStr + '</td>' +
        '</tr>';
    }).join('');

    area.innerHTML = summary +
      '<div class="table-wrap"><table><thead><tr>' +
      '<th>æ—¥ä»˜</th><th>ã‚·ãƒ•ãƒˆ</th><th>é‡‘å‹</th><th>ç”Ÿç”£æ•°ï¼ˆåˆè¨ˆï¼‰</th><th>ä¸è‰¯æ•°</th><th>ä¸è‰¯ç‡</th><th>ç¨®åˆ¥å†…è¨³</th>' +
      '</tr></thead><tbody>' + rows + '</tbody></table></div>' +
      '<div class="form-actions" style="border-top:none;padding-top:0;margin-top:1rem">' +
      '<button class="btn btn-secondary" onclick="cancelLotImport()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' +
      '<button class="btn btn-primary" onclick="importLotData()">âœ“ å–è¾¼ç¢ºå®š</button>' +
      '</div>';
  }

  function cancelLotImport() {
    lotPreviewData = [];
    document.getElementById('lot-preview-area').innerHTML = '';
    document.getElementById('part-excel-input').value = '';
  }

  function importLotData() {
    if (!lotPreviewData.length) return;
    let added = 0, updated = 0;
    const base = Date.now();

    // â”€â”€ Step1: åŒä¸€ãƒ­ãƒƒãƒˆï¼ˆå“ç•ª+é‡‘å‹+æ—¥ä»˜+ã‚·ãƒ•ãƒˆï¼‰ãŒè¤‡æ•°åˆ—ã‚ã‚‹å ´åˆã‚’å…ˆã«ã¾ã¨ã‚ã‚‹ â”€â”€
    // ç”Ÿç”£æ•°ã¯åˆè¨ˆã€ä¸è‰¯ã¯ç¨®åˆ¥ã”ã¨ã«åˆç®—ã—ã¦ã‹ã‚‰ records ã«åæ˜ ã™ã‚‹ã€‚
    // ã“ã‚Œã‚’ã—ãªã„ã¨ã€ãƒ«ãƒ¼ãƒ—ä¸­ã«è‡ªåˆ†ã§è¿½åŠ ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ã¦ã—ã¾ã„
    // ä¸è‰¯ãŒ 2 å€ãƒ»ç”Ÿç”£æ•°ãŒ 1 åˆ—åˆ†ã ã‘ã«ãªã£ã¦ä¸è‰¯ç‡ãŒè·³ã­ä¸ŠãŒã‚‹ã€‚
    const batchMap = new Map();
    for (const p of lotPreviewData) {
      const key = p.partNumber + '|' + p.moldNumber + '|' + p.date + '|' + p.shift;
      if (batchMap.has(key)) {
        const g = batchMap.get(key);
        const merged = mergeDefects(g.defects, p.defects);
        const tot    = merged.reduce((s, d) => s + d.count, 0);
        const prod   = (g.production || 0) + (p.production || 0); // ç”Ÿç”£æ•°ã¯åˆç®—
        g.defects      = merged;
        g.totalDefects = tot;
        g.production   = prod || null;
        g.defectRate   = prod ? tot / prod * 100 : null;
      } else {
        batchMap.set(key, { ...p });
      }
    }

    // â”€â”€ Step2: ã¾ã¨ã‚ãŸçµæœã‚’æ—¢å­˜ records ã¨ç…§åˆ â”€â”€
    // å†å–è¾¼ï¼ˆæ—¢å­˜ã‚ã‚Šï¼‰ã¯ä¸Šæ›¸ãã€‚åˆç®—ã™ã‚‹ã¨2é‡å–è¾¼ã«ãªã‚‹ãŸã‚ã€‚
    [...batchMap.values()].forEach((p, i) => {
      const idx = records.findIndex(r =>
        r.source === 'excel' &&
        r.partNumber === p.partNumber &&
        r.moldNumber === p.moldNumber &&
        r.date === p.date &&
        r.shift === p.shift
      );
      if (idx >= 0) {
        // å†å–è¾¼: Excelã®æœ€æ–°å€¤ã§ä¸Šæ›¸ãï¼ˆãƒãƒ¼ã‚¸ã§ã¯ãªãç½®æ›ï¼‰
        records[idx] = {
          ...records[idx],
          production:   p.production || null,
          totalDefects: p.totalDefects,
          defectRate:   p.production ? p.totalDefects / p.production * 100 : null,
          defects:      p.defects,
          lotId:        p.lotId
        };
        updated++;
      } else {
        records.push({
          id:           base + i,
          date:         p.date,
          shift:        p.shift,
          production:   p.production || null,
          totalDefects: p.totalDefects,
          defectRate:   p.production ? p.totalDefects / p.production * 100 : null,
          defects:      p.defects,
          source:       'excel',
          partNumber:   p.partNumber,
          moldNumber:   p.moldNumber,
          lotId:        p.lotId
        });
        added++;
      }
    });

    sortRecords();
    saveToStorage();
    renderAllTables();
    updateStats();
    cancelLotImport();
    showAlert('âœ“ å–è¾¼å®Œäº†ï¼šæ–°è¦ ' + added + ' ä»¶ã€æ›´æ–° ' + updated + ' ä»¶', 'success');
  }

  // ===========================
  //  File System Access API - ãƒ‘ã‚¹æŒ‡å®šå–è¾¼
  // ===========================
  const _FS_DB   = 'defect-fs-db';
  const _FS_STORE = 'handles';
  const _FS_KEY   = 'excelFolder';

  function _openFsDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(_FS_DB, 1);
      req.onupgradeneeded = e => e.target.result.createObjectStore(_FS_STORE);
      req.onsuccess = e => resolve(e.target.result);
      req.onerror   = e => reject(e.target.error);
    });
  }

  async function _saveFolderHandle(handle) {
    const db = await _openFsDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(_FS_STORE, 'readwrite');
      tx.objectStore(_FS_STORE).put(handle, _FS_KEY);
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  }

  async function _loadFolderHandle() {
    const db = await _openFsDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(_FS_STORE, 'readonly');
      const req = tx.objectStore(_FS_STORE).get(_FS_KEY);
      req.onsuccess = e => resolve(e.target.result || null);
      req.onerror   = e => reject(e.target.error);
    });
  }

  async function initFolderDisplay() {
    try {
      const handle = await _loadFolderHandle();
      if (handle) document.getElementById('excel-folder-path').textContent = handle.name;
    } catch(e) { /* IndexedDBæœªå¯¾å¿œç’°å¢ƒã§ã¯ã‚¹ã‚­ãƒƒãƒ— */ }
  }

  function initPathPartSelect() {
    const sel = document.getElementById('path-part-select');
    sel.innerHTML = PART_CONFIGS.map(c =>
      '<option value="' + c.id + '">' + c.label + '</option>'
    ).join('');
  }

  function _setFolderStatus(msg) {
    const el = document.getElementById('excel-folder-status');
    el.textContent = msg;
    el.style.display = msg ? 'block' : 'none';
  }

  async function selectExcelFolder() {
    if (!window.showDirectoryPicker) {
      // Safari / Firefox ãªã©éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ï¼šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¡ˆå†…ã‚’è¡¨ç¤º
      _setFolderStatus('âš  ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChrome / Edge ãŒå¿…è¦ï¼‰ã€‚ã€Œâ–¶ èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¾ã™ã€‚');
      document.getElementById('excel-folder-path').textContent = 'éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeæ¨å¥¨ï¼‰';
      return;
    }
    _setFolderStatus('');
    try {
      const handle = await window.showDirectoryPicker({ mode: 'read' });
      await _saveFolderHandle(handle);
      document.getElementById('excel-folder-path').textContent = handle.name;
      showAlert('âœ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨­å®šã—ã¾ã—ãŸ: ' + handle.name, 'success');
    } catch(e) {
      if (e.name !== 'AbortError') {
        _setFolderStatus('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
  }

  async function loadExcelByFilename() {
    const configId = document.getElementById('path-part-select').value;
    const cfg = PART_CONFIGS.find(c => c.id === configId);
    if (!cfg) { showAlert('å“ç•ªã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }

    // showDirectoryPicker éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ â†’ å¾“æ¥ã® file input ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!window.showDirectoryPicker) {
      currentPartConfig = cfg;
      const inp = document.getElementById('part-excel-input');
      inp.value = '';
      inp.click();
      return;
    }

    const filename = (document.getElementById('excel-filename').value || '').trim();
    if (!filename) { _setFolderStatus('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    let handle;
    try { handle = await _loadFolderHandle(); }
    catch(e) { _setFolderStatus('ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }

    // ãƒ•ã‚©ãƒ«ãƒ€æœªè¨­å®š â†’ é€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!handle) {
      _setFolderStatus('ãƒ•ã‚©ãƒ«ãƒ€ãŒæœªè¨­å®šã§ã™ã€‚å…ˆã«ã€Œãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨­å®šã€ã‚’æŠ¼ã™ã‹ã€ãã®ã¾ã¾èª­ã¿è¾¼ã‚€ã¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¾ã™ã€‚');
      currentPartConfig = cfg;
      const inp = document.getElementById('part-excel-input');
      inp.value = '';
      inp.click();
      return;
    }

    _setFolderStatus('');
    try {
      const perm = await handle.queryPermission({ mode: 'read' });
      if (perm !== 'granted') {
        const req = await handle.requestPermission({ mode: 'read' });
        if (req !== 'granted') { _setFolderStatus('ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      }
      const fileHandle = await handle.getFileHandle(filename);
      const file = await fileHandle.getFile();
      currentPartConfig = cfg;
      handlePartExcelFile(file);
    } catch(e) {
      if (e.name === 'NotFoundError') {
        _setFolderStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + filename);
      } else {
        _setFolderStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
  }

  // ===========================
  //  Chart helpers
  // ===========================
  function showChartEmpty(canvas, msg) {
    canvas.style.display = 'none';
    let el = canvas.parentElement.querySelector('.chart-empty');
    if (!el) {
      el = document.createElement('div');
      el.className = 'empty-state chart-empty';
      canvas.parentElement.appendChild(el);
    }
    el.innerHTML = '<div class="empty-icon">ğŸ“­</div><p>' + msg + '</p>';
    el.style.display = 'block';
  }

  function hideChartEmpty(canvas) {
    canvas.style.display = 'block';
    const el = canvas.parentElement.querySelector('.chart-empty');
    if (el) el.style.display = 'none';
  }
</script>
</body>
</html>
